# 基于Fuwari框架的个人博客搭建与Cloudflare Pages部署教程

本教程将详细指导您如何使用Fuwari框架搭建个人博客，并通过Cloudflare Pages服务进行部署，同时设置自定义域名。

## 目录

- [前置准备](#前置准备)
- [第一部分：获取并配置Fuwari框架](#第一部分获取并配置fuwari框架)
- [第二部分：本地开发与内容创建](#第二部分本地开发与内容创建)
- [第三部分：部署到GitHub](#第三部分部署到github)
- [第四部分：配置Cloudflare Pages](#第四部分配置cloudflare-pages)
- [第五部分：设置自定义域名](#第五部分设置自定义域名)
- [第六部分：配置Twikoo评论系统](#第六部分配置twikoo评论系统)
- [常见问题与解决方案](#常见问题与解决方案)

## 前置准备

在开始搭建博客前，请确保您已准备好以下工具和账号：

1. **开发环境**：
   - [Node.js](https://nodejs.org/) 18.x 或更高版本
   - [Git](https://git-scm.com/)
   - 一个代码编辑器，如 [Visual Studio Code](https://code.visualstudio.com/)

2. **账号**：
   - [GitHub](https://github.com/) 账号（用于代码托管）
   - [Cloudflare](https://www.cloudflare.com/) 账号（用于网站托管和域名管理）

3. **可选**：
   - 自己的域名（如果您想使用自定义域名）
   - [MongoDB Atlas](https://www.mongodb.com/cloud/atlas) 账号（如果您想使用Twikoo评论系统）

## 第一部分：获取并配置Fuwari框架

### 1.1 获取Fuwari框架

有两种方式获取Fuwari框架：

**方法一：使用模板创建仓库（推荐）**
1. 访问 [Fuwari GitHub仓库](https://github.com/saicaca/fuwari)
2. 点击"Use this template"按钮，选择"Create a new repository"
3. 填写新仓库名称（例如：`my-blog`），设置为公开（Public）
4. 点击"Create repository from template"

**方法二：Fork仓库**
1. 访问 [Fuwari GitHub仓库](https://github.com/saicaca/fuwari)
2. 点击右上角的"Fork"按钮
3. 设置仓库名称，然后点击"Create fork"

### 1.2 将仓库克隆到本地

打开终端（命令行），执行以下命令：

```bash
# 替换 YOUR_USERNAME 为您的GitHub用户名，REPO_NAME 为仓库名称
git clone https://github.com/YOUR_USERNAME/REPO_NAME.git
cd REPO_NAME
```

### 1.3 安装依赖

Fuwari使用pnpm作为包管理器，请先安装pnpm，然后安装项目依赖：

```bash
# 安装pnpm（如果尚未安装）
npm install -g pnpm

# 安装项目依赖
pnpm install
pnpm add sharp
```

### 1.4 基础配置修改

编辑`src/config.ts`文件，自定义您的博客设置：

```typescript
export const siteConfig: SiteConfig = {
  title: "您的博客名称", // 修改为您的博客名称
  subtitle: "博客副标题", // 修改为您的博客副标题
  lang: "zh_CN", // 语言设置：'en', 'zh_CN', 'zh_TW', 'ja', 'ko', 'es', 'th'
  themeColor: {
    hue: 280, // 主题色调，0-360之间的值
    fixed: true, // 是否固定主题色（不允许访客修改）
  },
  // 更多配置...
};
```

编辑个人资料信息：

```typescript
export const profileConfig: ProfileConfig = {
  avatar: "assets/images/avatar.jpg", // 头像路径，建议放在src/assets/images目录下
  name: "您的名字", // 修改为您的名字
  bio: "您的个人简介", // 修改为您的个人简介
  links: [
    // 您的社交媒体链接，可以添加或移除
    {
      name: "GitHub",
      icon: "fa6-brands:github",
      url: "https://github.com/YOUR_USERNAME",
    },
    // 更多链接...
  ],
};
```

### 1.5 更换头像和横幅

1. 将您的头像文件放入`src/assets/images/`目录，并在`config.ts`中更新路径
2. 如果要启用横幅，将横幅图片放入`src/assets/images/`目录，并在`config.ts`中设置：

```typescript
banner: {
  enable: true, // 改为true以启用横幅
  src: "assets/images/your-banner.jpg", // 更新为您的横幅图片路径
  position: "center", // 图片位置：'top', 'center', 'bottom'
},
```

## 第二部分：本地开发与内容创建

### 2.1 启动开发服务器

执行以下命令启动本地开发服务器：

```bash
pnpm dev
```

现在您可以在浏览器中访问`http://localhost:4321`查看您的博客。

### 2.2 创建新文章

使用内置命令创建新文章：

```bash
# 将filename替换为您想要的文件名（不需要扩展名）
pnpm new-post filename
```

这将在`src/content/posts/`目录下创建一个新的Markdown文件。

### 2.3 编辑文章

打开新创建的Markdown文件，您会看到类似以下的前置信息：

```yaml
---
title: My First Blog Post
published: 2023-09-09
description: This is the first post of my new Astro blog.
image: ./cover.jpg
tags: [Foo, Bar]
category: Front-end
draft: false
---
```

修改这些字段：

- `title`: 文章标题
- `published`: 发布日期（格式：YYYY-MM-DD）
- `description`: 文章简介
- `image`: 封面图片路径（相对于文章所在目录）
- `tags`: 文章标签
- `category`: 文章分类
- `draft`: 是否为草稿（`true`表示草稿，不会在生产环境显示）
- `lang`: （可选）文章语言，仅当与网站默认语言不同时需要设置

在前置信息下方编写您的文章内容（使用Markdown格式）。

### 2.4 添加封面图片

如果您在文章前置信息中指定了`image`字段，请确保在文章所在目录放置对应的图片文件。例如，对于文章`src/content/posts/my-first-post.md`，封面图片路径为`src/content/posts/cover.jpg`。

### 2.5 本地预览

编辑完成后，您可以在本地开发服务器中实时预览您的博客。如果开发服务器未运行，请执行：

```bash
pnpm dev
```

## 第三部分：部署到GitHub

### 3.1 提交更改

完成本地开发后，将更改提交到Git仓库：

```bash
git add .
git commit -m "初始化博客内容"
```

### 3.2 推送到GitHub

将更改推送到GitHub仓库：

```bash
git push origin main
```

## 第四部分：配置Cloudflare Pages

### 4.1 设置pnpm-lock.yaml与package.json同步

为了避免在Cloudflare Pages构建时出现依赖问题，需要确保`pnpm-lock.yaml`与`package.json`同步。在项目根目录创建或修改`.npmrc`文件：

```
manage-package-manager-versions = true
frozen-lockfile = false
```

### 4.2 创建Cloudflare Pages配置文件

在项目根目录创建以下文件，以配置Cloudflare Pages的构建和路由：

**1. 创建`public/_redirects`文件**

```
# 这个文件是为了让Cloudflare Pages识别这是一个静态网站项目
/* /index.html 200
```

**2. 创建`public/_headers`文件**

```
/*
  X-Frame-Options: DENY
  X-Content-Type-Options: nosniff
  X-XSS-Protection: 1; mode=block
  
# 静态资源缓存
/assets/*
  Cache-Control: public, max-age=31536000, immutable
```

**3. 创建`.cloudflare/pages-config.json`文件**

```json
{
  "build": {
    "command": "pnpm install --no-frozen-lockfile && pnpm run build",
    "output_directory": "dist"
  }
}
```

### 4.3 在Cloudflare Pages中创建项目

1. 登录您的[Cloudflare Dashboard](https://dash.cloudflare.com/)
2. 在左侧菜单中选择"Pages"
3. 点击"创建一个项目"
4. 选择"连接到Git"
5. 选择GitHub作为Git提供商
6. 授权Cloudflare访问您的GitHub仓库
7. 从列表中选择您的博客仓库
8. 在基本配置中：
   - 项目名称：自定义项目名称（如`my-blog`）
   - 生产分支：`main`
   - 构建设置：
     - 构建命令：`pnpm install --no-frozen-lockfile && pnpm run build`
     - 构建输出目录：`dist`
9. 点击"保存并部署"

Cloudflare将开始构建和部署您的网站。部署完成后，您将获得一个`*.pages.dev`的网址。

### 4.4 检查部署状态和日志

1. 在Cloudflare Pages项目中，点击"部署"标签查看部署历史
2. 点击最新的部署查看详细信息和构建日志
3. 如果遇到构建错误，请检查日志以识别问题所在
4. 成功部署后，点击提供的URL查看您的网站

## 第五部分：设置自定义域名

### 5.1 添加自定义域名

1. 在Cloudflare Pages项目中，选择"自定义域"标签
2. 点击"设置自定义域"按钮
3. 输入您的域名（例如：`blog.example.com`）
4. 选择DNS记录类型（通常为CNAME）
5. 点击"继续"

### 5.2 配置DNS记录

**如果您的域名已在Cloudflare管理：**

1. Cloudflare将自动为您添加必要的DNS记录
2. 等待DNS传播（通常不超过几分钟）

**如果您的域名不在Cloudflare管理：**

1. 前往您的域名注册商的DNS管理页面
2. 添加一条CNAME记录：
   - 名称/主机：您要使用的子域名（如`blog`）
   - 目标/值：Cloudflare Pages提供的`*.pages.dev`域名
3. 保存DNS记录更改
4. 等待DNS传播（通常需要几分钟到几小时）

### 5.3 配置域名重定向

如果您希望访问者从一个域名自动跳转到另一个域名（例如：从`old-domain.com`跳转到`new-domain.com`），可以创建以下配置：

**1. 在Cloudflare Pages项目中添加两个自定义域名**
- 添加源域名（如`old-domain.com`）
- 添加目标域名（如`new-domain.com`）

**2. 创建`_redirects`文件实现重定向**

修改`public/_redirects`文件：

```
# 从源域名重定向到目标域名
https://old-domain.com/* https://new-domain.com/:splat 301!
https://www.old-domain.com/* https://new-domain.com/:splat 301!

# 以下确保SPA正常工作
/* /index.html 200
```

这样当用户访问`old-domain.com`时，会自动跳转到`new-domain.com`，同时保持URL路径不变。

### 5.4 配置SSL/HTTPS

Cloudflare Pages自动为所有网站提供SSL证书，确保通过HTTPS访问。默认情况下：

1. 所有HTTP请求会自动重定向到HTTPS
2. 证书自动管理和更新
3. 您不需要额外配置SSL/HTTPS

## 第六部分：配置Twikoo评论系统

Fuwari框架支持Twikoo评论系统，设置步骤如下：

### 6.1 创建MongoDB数据库

1. 注册并登录[MongoDB Atlas](https://www.mongodb.com/cloud/atlas/register)
2. 创建一个新的项目
3. 点击"Build a Database"，选择"FREE"共享集群（M0）
4. 选择云服务提供商和区域（推荐选择离您用户最近的区域）
5. 点击"Create Cluster"

### 6.2 设置数据库访问权限

1. 在左侧菜单中，选择"Security" > "Database Access"
2. 点击"Add New Database User"
3. 设置用户名和密码（请保存好这些信息！）
4. 设置权限为"Read and Write to Any Database"
5. 点击"Add User"

### 6.3 设置网络访问控制

1. 在左侧菜单中，选择"Security" > "Network Access"
2. 点击"Add IP Address"
3. 选择"Allow Access from Anywhere"（添加IP地址0.0.0.0/0）
4. 点击"Confirm"

### 6.4 获取MongoDB连接字符串

1. 在"Database"页面中，点击"Connect"按钮
2. 选择"Connect your application"
3. 在"Driver"下拉菜单中选择"Node.js"，版本选择最新
4. 复制提供的连接字符串（形如：`mongodb+srv://username:<password>@cluster0.xxx.mongodb.net/?retryWrites=true&w=majority`）
5. 在连接字符串中，将`<password>`替换为您的数据库用户密码

### 6.5 部署Twikoo云函数

1. Fork [Twikoo云函数仓库](https://github.com/imaegoo/twikoo)到您的GitHub账号
2. 登录[Vercel](https://vercel.com/)（如果没有账号，请使用GitHub账号注册）
3. 点击"New Project"
4. 导入您Fork的Twikoo仓库
5. 在配置页面：
   - 增加环境变量：键为`MONGODB_URI`，值为您在上一步获取的MongoDB连接字符串
   - 部署配置保持默认
6. 点击"Deploy"
7. 部署完成后，记录分配的域名（形如：`your-app-name.vercel.app`）

### 6.6 配置博客使用Twikoo

编辑项目中的`src/config.ts`文件：

```typescript
export const commentConfig: CommentConfig = {
  enable: true, // 启用评论系统
  system: 'twikoo', // 评论系统类型
  twikoo: {
    envId: 'https://your-app-name.vercel.app/', // 替换为您的Twikoo云函数URL
  }
};
```

### 6.7 部署并验证

1. 提交并推送更改到GitHub
2. Cloudflare Pages会自动重新部署您的网站
3. 部署完成后，访问博客文章页面，检查评论系统是否正常工作

## 常见问题与解决方案

### 1. Cloudflare Pages构建失败

**问题描述**：构建过程报错 `ERR_PNPM_OUTDATED_LOCKFILE Cannot install with "frozen-lockfile" because pnpm-lock.yaml is not up to date with package.json`

**解决方案**：
1. 确保添加了`frozen-lockfile = false`到`.npmrc`文件
2. 修改`.cloudflare/pages-config.json`文件中的构建命令为`pnpm install --no-frozen-lockfile && pnpm run build`
3. 在Cloudflare Pages项目设置中，将构建命令修改为`pnpm install --no-frozen-lockfile && pnpm run build`

### 2. 自定义域名设置后无法访问

**问题描述**：添加自定义域名后，访问网站显示"DNS解析错误"

**解决方案**：
1. 检查DNS记录是否正确配置
2. 使用[dnschecker.org](https://dnschecker.org)验证DNS记录是否已全球传播
3. 在Cloudflare Pages项目的"自定义域"页面，确认域名状态是"活跃"

### 3. 博客文章不显示

**问题描述**：添加了新文章，但在网站上看不到

**解决方案**：
1. 检查文章的`draft`字段是否设置为`false`
2. 确认`published`日期不是未来日期
3. 重新构建和部署网站

### 4. 评论系统不工作

**问题描述**：文章页面中评论区域显示错误或不加载

**解决方案**：
1. 检查`src/config.ts`中的`commentConfig`设置
2. 确认Twikoo云函数URL是否正确
3. 查看浏览器控制台是否有错误信息
4. 确保MongoDB连接字符串正确，且网络访问控制允许来自Vercel的连接

### 5. 文章图片不显示

**问题描述**：文章中的图片不显示

**解决方案**：
1. 确认图片路径是否正确
2. 对于文章内的图片，使用相对路径（如`./images/photo.jpg`）
3. 将图片放在与文章相同的目录或子目录中
4. 重新构建和部署网站

---

恭喜您！通过本教程，您已经成功搭建了基于Fuwari框架的个人博客，并通过Cloudflare Pages部署，还配置了自定义域名和Twikoo评论系统。现在您可以专注于创作优质内容，并与全世界分享您的想法。

如果您遇到任何其他问题，请查阅[Fuwari文档](https://github.com/saicaca/fuwari)或[Cloudflare Pages文档](https://developers.cloudflare.com/pages/)，或者在GitHub仓库提交Issue。

祝您的博客之旅愉快！
