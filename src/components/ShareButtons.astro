---
import { Icon } from "astro-icon/components";
import { siteConfig } from "../config";

// 简单版本的 ShareButtons 组件
const title = Astro.props.title || "";
const url = Astro.props.url || Astro.url.href;
const className = Astro.props.class || "";

// 确保URL是完整的、有效的URL（包含协议）
let fullUrl = url;
if (!url.startsWith('http')) {
  fullUrl = 'https://' + (new URL(Astro.url.pathname, Astro.site)).host + url;
}

const encodedUrl = encodeURIComponent(fullUrl);
const encodedTitle = encodeURIComponent(title);
const encodedSource = encodeURIComponent(siteConfig.title);

// QQ分享链接
const qqShareUrl = "https://connect.qq.com/widget/shareqq/index.html?url=" + encodedUrl + "&title=" + encodedTitle + "&source=" + encodedSource;

// 微信二维码 - 使用内容更明确的二维码内容
const qrCodeContent = `网页标题: ${title}\n网址: ${fullUrl}\n来自: ${siteConfig.title}`;
const qrCodeUrl = "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" + encodeURIComponent(fullUrl);
---

<div class:list={["share-buttons", className]}>
  <div class="share-btns-container">
    <a href={qqShareUrl} target="_blank" rel="noopener noreferrer" class="share-btn qq-btn" aria-label="分享到QQ">
      <Icon name="fa6-brands:qq" class="share-icon" />
      <span>分享到QQ</span>
    </a>
    
    <button id="wechat-share-btn" class="share-btn wechat-btn" aria-label="分享到微信">
      <Icon name="fa6-brands:weixin" class="share-icon" />
      <span>分享到微信</span>
    </button>
  </div>
</div>

<!-- 微信二维码弹窗 -->
<div id="wechat-qrcode-modal" class="wechat-qrcode-modal">
  <div class="wechat-qrcode-container">
    <div class="wechat-qrcode-header">
      <h3>微信扫一扫分享</h3>
      <button id="close-qrcode-btn" class="close-qrcode-btn" aria-label="关闭">
        <span>✕</span>
      </button>
    </div>
    <div class="wechat-qrcode-content">
      <img src={qrCodeUrl} alt="微信分享二维码" class="qrcode-image" />
      <p>微信扫描二维码打开网页后点击右上角"..."分享</p>
      <p class="qrcode-url">{fullUrl}</p>
    </div>
  </div>
</div>

<style>
  .share-buttons {
    margin: 1.5rem 0;
    display: flex;
    justify-content: flex-start;
  }
  
  .share-btns-container {
    display: flex;
    gap: 0.5rem;
  }
  
  .share-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-small, 4px);
    text-decoration: none;
    border: 1px solid var(--line-divider, #ddd);
    background-color: var(--bg-card, #f8f8f8);
    color: var(--text-secondary, #666);
    transition: all 0.2s ease;
    cursor: pointer;
  }
  
  .share-icon {
    width: 1.25rem;
    height: 1.25rem;
  }
  
  .qq-btn:hover {
    background-color: rgba(0, 120, 215, 0.1);
    color: #12b7f5;
  }
  
  .wechat-btn:hover {
    background-color: rgba(0, 215, 60, 0.1);
    color: #07c160;
  }
  
  /* 微信二维码弹窗样式 */
  .wechat-qrcode-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 30;
    display: none;
    justify-content: center;
    align-items: center;
  }
  
  .wechat-qrcode-container {
    background-color: var(--bg-card, white);
    border-radius: var(--radius-medium, 8px);
    width: 90%;
    max-width: 320px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }
  
  .wechat-qrcode-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid var(--line-divider, #eee);
  }
  
  .wechat-qrcode-header h3 {
    margin: 0;
    font-size: 1rem;
    color: var(--text-primary, #333);
  }
  
  .close-qrcode-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.25rem;
    color: var(--text-secondary, #666);
    padding: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .wechat-qrcode-content {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
  }
  
  .qrcode-image {
    width: 200px;
    height: 200px;
    border: 1px solid var(--line-divider, #eee);
  }
  
  .wechat-qrcode-content p {
    text-align: center;
    font-size: 0.875rem;
    color: var(--text-secondary, #666);
    margin: 0;
  }
  
  .qrcode-url {
    font-size: 0.75rem;
    color: var(--text-tertiary, #999);
    word-break: break-all;
    max-width: 100%;
  }
  
  /* 显示弹窗的类 */
  .show {
    display: flex !important;
  }
</style>

<script>
  // 等待页面加载完成
  document.addEventListener('DOMContentLoaded', function() {
    const wechatBtn = document.getElementById('wechat-share-btn');
    const qrcodeModal = document.getElementById('wechat-qrcode-modal');
    const closeBtn = document.getElementById('close-qrcode-btn');
    
    // 点击分享到微信按钮显示二维码
    if (wechatBtn && qrcodeModal) {
      wechatBtn.addEventListener('click', function() {
        qrcodeModal.classList.add('show');
      });
    }
    
    // 点击关闭按钮隐藏二维码
    if (closeBtn && qrcodeModal) {
      closeBtn.addEventListener('click', function() {
        qrcodeModal.classList.remove('show');
      });
    }
    
    // 点击弹窗背景关闭弹窗
    if (qrcodeModal) {
      qrcodeModal.addEventListener('click', function(event) {
        if (event.target === qrcodeModal) {
          qrcodeModal.classList.remove('show');
        }
      });
    }
  });
</script> 