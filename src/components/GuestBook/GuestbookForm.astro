---
// é¢„è®¾æ ·å¼é€‰é¡¹
const stylePresets = [
  { name: 'ç®€çº¦ç™½', backgroundColor: '#ffffff', textColor: '#374151', borderStyle: 'solid', boxShadow: '0 4px 6px rgba(0, 0, 0, 0.05)' },
  { name: 'æš–é˜³', backgroundColor: '#fff7ed', textColor: '#c2410c', borderStyle: 'solid', boxShadow: '0 4px 10px rgba(194, 65, 12, 0.1)' },
  { name: 'æµ·æ´‹', backgroundColor: '#f0f9ff', textColor: '#0369a1', borderStyle: 'solid', boxShadow: '0 4px 10px rgba(3, 105, 161, 0.1)' },
  { name: 'æ£®æ—', backgroundColor: '#f0fdf4', textColor: '#166534', borderStyle: 'solid', boxShadow: '0 4px 10px rgba(22, 101, 52, 0.1)' },
  { name: 'æ™šéœ', backgroundColor: '#fef2f2', textColor: '#b91c1c', borderStyle: 'solid', boxShadow: '0 4px 10px rgba(185, 28, 28, 0.1)' },
  { name: 'è‘¡è„', backgroundColor: '#faf5ff', textColor: '#7e22ce', borderStyle: 'dashed', boxShadow: '0 4px 10px rgba(126, 34, 206, 0.1)' },
  { name: 'æ¨±èŠ±', backgroundColor: '#fdf4ff', textColor: '#a21caf', borderStyle: 'dashed', boxShadow: '0 4px 10px rgba(162, 28, 175, 0.1)' },
  { name: 'æ¸…æ–°', backgroundColor: '#ecfeff', textColor: '#0e7490', borderStyle: 'dotted', boxShadow: '0 4px 10px rgba(14, 116, 144, 0.1)' },
  { name: 'ç°è°ƒ', backgroundColor: '#f8fafc', textColor: '#334155', borderStyle: 'none', boxShadow: '0 4px 6px rgba(51, 65, 85, 0.05)' },
  { name: 'æ—¥è½', backgroundColor: '#fefce8', textColor: '#854d0e', borderStyle: 'solid', boxShadow: '0 4px 10px rgba(133, 77, 14, 0.1)' },
  { name: 'å®é™', backgroundColor: '#f5f5f5', textColor: '#262626', borderStyle: 'solid', boxShadow: '0 4px 6px rgba(0, 0, 0, 0.03)' },
  { name: 'ç«ç‘°', backgroundColor: '#fff1f2', textColor: '#be123c', borderStyle: 'solid', boxShadow: '0 4px 10px rgba(190, 18, 60, 0.1)' }
];

// å¸¸ç”¨è¡¨æƒ…åˆ—è¡¨
const commonEmojis = [
  'ğŸ˜Š', 'ğŸ˜‚', 'ğŸ¥°', 'ğŸ˜', 'ğŸ˜', 'ğŸ¤”', 'ğŸ˜„', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜˜',
  'ğŸ‘', 'ğŸ‰', 'ğŸ”¥', 'âœ¨', 'ğŸ’–', 'ğŸ’•', 'ğŸ’¯', 'ğŸ™', 'ğŸ‘', 'ğŸŒ¹',
  'ğŸ˜­', 'ğŸ˜¢', 'ğŸ˜¡', 'ğŸ¤©', 'ğŸ˜´', 'ğŸ¤—', 'ğŸ¤«', 'ğŸ¤ª', 'ğŸ˜‡', 'ğŸ¥³'
];

// è¡¨æƒ…åˆ†ç±»
const emojiCategories = [
  { name: 'å¸¸ç”¨', icon: 'ğŸ˜Š' },
  { name: 'è¡¨æƒ…', icon: 'ğŸ˜€' },
  { name: 'æ‰‹åŠ¿', icon: 'ğŸ‘' },
  { name: 'åŠ¨ç‰©', icon: 'ğŸ±' },
  { name: 'é£Ÿç‰©', icon: 'ğŸ' },
  { name: 'è‡ªç„¶', icon: 'ğŸŒˆ' },
  { name: 'ç¬¦å·', icon: 'â¤ï¸' }
];
---

<div class="guestbook-form bg-white/80 backdrop-blur-sm shadow-lg px-5 py-6 relative w-full max-w-2xl mx-auto rounded-xl border border-gray-100">
  
  <!-- é”™è¯¯ä¿¡æ¯ -->
  <div id="form-error-message" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4 hidden">
    <p class="font-bold">æäº¤å¤±è´¥</p>
    <p class="text-sm" id="error-message-text"></p>
  </div>
  
  <!-- æˆåŠŸä¿¡æ¯ -->
  <div id="form-success-message" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4 hidden">
    <p class="font-bold">æäº¤æˆåŠŸ</p>
    <p class="text-sm">ç•™è¨€å·²æˆåŠŸæäº¤ï¼Œæ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼</p>
  </div>
  
  <!-- åŠ è½½çŠ¶æ€æç¤º -->
  <div id="form-loading-message" class="bg-blue-50 border border-blue-200 text-blue-700 px-4 py-3 rounded mb-4 hidden">
    <div class="flex items-center">
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      <p><span class="font-medium">ç•™è¨€æäº¤ä¸­...</span> è¯·ç¨å€™ï¼Œè¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ</p>
    </div>
  </div>
  
  <!-- ä½¿ç”¨å®¢æˆ·ç«¯JavaScriptæäº¤è¡¨å• -->
  <form 
    id="guestbook-form" 
    class="space-y-4"
    onsubmit="handleFormSubmit(event); return false;"
  >
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <!-- æ˜µç§° -->
      <div class="form-control">
        <label for="nickname" class="block mb-1 text-sm font-medium">æ˜µç§° <span class="text-red-500">*</span></label>
        <input 
          type="text" 
          id="nickname" 
          name="nickname" 
          required 
          maxlength="30"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200 shadow-sm"
          placeholder="è¯·è¾“å…¥ä½ çš„æ˜µç§°"
          onInput="updatePreview()"
        />
      </div>
      
      <!-- QQé‚®ç®± -->
      <div class="form-control">
        <label for="qq-email" class="block mb-1 text-sm font-medium">QQé‚®ç®± (å¯è·å–å¤´åƒ)</label>
        <input 
          type="email" 
          id="qq-email" 
          name="qq_email" 
          pattern="[0-9]+@qq\.com"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200 shadow-sm"
          placeholder="ä¾‹å¦‚ï¼š123456@qq.com"
          onInput="updateQQAvatar()"
        />
        <p class="text-xs text-gray-500 mt-1">å¡«å†™QQé‚®ç®±å¯è‡ªåŠ¨è·å–QQå¤´åƒ</p>
      </div>
    </div>
    
    <!-- ç•™è¨€å†…å®¹ -->
    <div class="form-control relative">
      <label for="content" class="block mb-1 text-sm font-medium">ç•™è¨€å†…å®¹ <span class="text-red-500">*</span></label>
      <div class="relative">
        <textarea 
          id="content" 
          name="content" 
          required 
          rows="3"
          maxlength="500"
          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200 shadow-sm"
          placeholder="å†™ä¸‹ä½ çš„ç•™è¨€..."
          onInput="updatePreview(); updateContentLength();"
        ></textarea>
        
        <!-- è¡¨æƒ…é€‰æ‹©å™¨æŒ‰é’® -->
        <button 
          type="button" 
          id="emoji-button"
          class="absolute right-2 bottom-2 text-gray-500 hover:text-gray-700 transition-colors p-1 rounded-full hover:bg-gray-100"
          aria-label="æ’å…¥è¡¨æƒ…"
          onClick="toggleEmojiPicker()"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </button>
      </div>
      
      <!-- è¡¨æƒ…é€‰æ‹©å™¨é¢æ¿ -->
      <div id="emoji-picker" class="hidden absolute z-10 right-0 bottom-16 bg-white border border-gray-200 rounded-lg shadow-xl p-3 w-full max-w-md">
        <!-- è¡¨æƒ…åˆ†ç±»é€‰é¡¹å¡ -->
        <div class="flex border-b border-gray-200 mb-2 pb-2 overflow-x-auto">
          {emojiCategories.map((category, index) => (
            <button 
              type="button"
              class={`emoji-category-tab px-3 py-2 text-sm whitespace-nowrap ${index === 0 ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500 hover:text-gray-700'}`}
              data-category={category.name}
              onClick={`switchEmojiCategory('${category.name}')`}
            >
              <span class="mr-1">{category.icon}</span>
              <span>{category.name}</span>
            </button>
          ))}
        </div>
        
        <!-- è¡¨æƒ…å†…å®¹åŒºåŸŸ -->
        <div class="emoji-container grid grid-cols-8 gap-2 max-h-48 overflow-y-auto p-2">
          {commonEmojis.map(emoji => (
            <button 
              type="button"
              class="emoji-btn w-8 h-8 text-xl flex items-center justify-center hover:bg-blue-50 rounded-md transition-colors"
              onClick={`insertEmoji('${emoji}')`}
            >
              {emoji}
            </button>
          ))}
        </div>
      </div>
      
      <div class="flex justify-between items-center mt-1">
        <p class="text-xs text-gray-500">
          <span id="content-length">0</span>/500 å­—
        </p>
      </div>
    </div>
    
    <!-- æ ·å¼é€‰æ‹© -->
    <div class="form-control">
      <label class="block mb-1 text-sm font-medium">é€‰æ‹©ç•™è¨€æ ·å¼</label>
      
      <div class="grid grid-cols-4 md:grid-cols-6 gap-2 overflow-x-auto hide-scrollbar">
        {stylePresets.map((style, index) => (
          <button 
            type="button"
            class="style-preset p-1.5 rounded-lg border text-center text-xs transition-all transform hover:-translate-y-1"
            data-index={index}
            data-background={style.backgroundColor}
            data-textcolor={style.textColor}
            data-borderstyle={style.borderStyle}
            data-boxshadow={style.boxShadow}
            style={`background-color: ${style.backgroundColor}; color: ${style.textColor}; border-style: ${style.borderStyle}; box-shadow: ${style.boxShadow};`}
            onClick={`setStylePreset(${index})`}
          >
            {style.name}
          </button>
        ))}
      </div>
      
      <!-- éšè—å­—æ®µç”¨äºå­˜å‚¨æ ·å¼å€¼å’ŒIPå“ˆå¸Œ -->
      <input type="hidden" id="background-color" name="background_color" value="#ffffff" />
      <input type="hidden" id="text-color" name="text_color" value="#374151" />
      <input type="hidden" id="border-style" name="border_style" value="solid" />
      <input type="hidden" id="ip-hash" name="ip_hash" value="anon-12345" />
      
      <!-- æ ·å¼é¢„è§ˆ -->
      <div class="mt-4">
        <p class="text-sm font-medium mb-2">é¢„è§ˆæ•ˆæœï¼š</p>
        <div 
          id="style-preview" 
          class="p-4 rounded-lg border shadow-lg transform transition-all duration-300"
          style="background-color: #ffffff; color: #374151; border-style: solid; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);"
        >
          <div class="flex items-center gap-3 mb-2">
            <div id="avatar-preview" class="w-8 h-8 rounded-full bg-gray-200 flex-shrink-0 shadow-sm"></div>
            <div>
              <div class="font-medium text-base" id="preview-nickname">è®¿å®¢</div>
              <div class="flex text-xs opacity-70 gap-2">
                <span>2023-06-25</span>
                <span class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 mr-0.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg>ä½ç½®é¢„è§ˆ</span>
              </div>
            </div>
          </div>
          <div id="preview-content" class="text-sm">è¿™æ˜¯ä¸€æ¡ç¤ºä¾‹ç•™è¨€å†…å®¹ï¼Œä½ å¯ä»¥è°ƒæ•´æ ·å¼çœ‹çœ‹æ•ˆæœå¦‚ä½•ã€‚</div>
        </div>
      </div>
    </div>
    
    <!-- æäº¤æŒ‰é’® -->
    <div class="flex justify-center mt-6">
      <button 
        type="submit" 
        id="submit-button"
        class="px-6 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all transform hover:-translate-y-1 shadow-md font-medium"
      >
        <span class="flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" />
          </svg>
          æäº¤ç•™è¨€
        </span>
      </button>
    </div>
  </form>
</div>

<!-- ä½¿ç”¨deferç¡®ä¿DOMå·²åŠ è½½ -->
<script is:inline>
  // å…¨å±€å®šä¹‰é¢„è§ˆæ›´æ–°å‡½æ•°
  function updatePreview() {
    const nickname = document.getElementById('nickname')?.value || 'è®¿å®¢';
    const content = document.getElementById('content')?.value || 'è¿™æ˜¯ä¸€æ¡ç¤ºä¾‹ç•™è¨€å†…å®¹ï¼Œä½ å¯ä»¥è°ƒæ•´æ ·å¼çœ‹çœ‹æ•ˆæœå¦‚ä½•ã€‚';
    const backgroundColor = document.getElementById('background-color')?.value || '#ffffff';
    const textColor = document.getElementById('text-color')?.value || '#374151';
    const borderStyle = document.getElementById('border-style')?.value || 'solid';
    
    const previewNickname = document.getElementById('preview-nickname');
    const previewContent = document.getElementById('preview-content');
    const stylePreview = document.getElementById('style-preview');
    
    if (previewNickname) previewNickname.textContent = nickname;
    if (previewContent) previewContent.textContent = content;
    if (stylePreview) {
      stylePreview.style.backgroundColor = backgroundColor;
      stylePreview.style.color = textColor;
      stylePreview.style.borderStyle = borderStyle;
    }
  }
  
  // æ›´æ–°å†…å®¹é•¿åº¦è®¡æ•°å™¨
  function updateContentLength() {
    const content = document.getElementById('content')?.value || '';
    const lengthDisplay = document.getElementById('content-length');
    if (lengthDisplay) lengthDisplay.textContent = content.length;
  }
  
  // åˆ‡æ¢è¡¨æƒ…é€‰æ‹©å™¨
  function toggleEmojiPicker() {
    const emojiPicker = document.getElementById('emoji-picker');
    if (emojiPicker) {
      emojiPicker.classList.toggle('hidden');
    }
  }
  
  // åˆ‡æ¢è¡¨æƒ…åˆ†ç±»
  function switchEmojiCategory(category) {
    // è®¾ç½®æ´»åŠ¨æ ‡ç­¾
    const tabs = document.querySelectorAll('.emoji-category-tab');
    tabs.forEach(tab => {
      if (tab.dataset.category === category) {
        tab.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
        tab.classList.remove('text-gray-500', 'hover:text-gray-700');
      } else {
        tab.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
        tab.classList.add('text-gray-500', 'hover:text-gray-700');
      }
    });
    
    // æ ¹æ®åˆ†ç±»åŠ è½½è¡¨æƒ…
    const emojiContainer = document.querySelector('.emoji-container');
    if (!emojiContainer) return;
    
    // æ ¹æ®åˆ†ç±»è·å–è¡¨æƒ…åˆ—è¡¨ï¼ˆè¿™é‡Œç®€åŒ–å®ç°ï¼Œå®é™…å¯ä»¥æ ¹æ®åˆ†ç±»è·å–ä¸åŒçš„è¡¨æƒ…ï¼‰
    const categoryEmojis = {
      'å¸¸ç”¨': ['ğŸ˜Š', 'ğŸ˜‚', 'ğŸ¥°', 'ğŸ˜', 'ğŸ˜', 'ğŸ¤”', 'ğŸ˜„', 'ğŸ˜…', 'ğŸ¤£', 'ğŸ˜˜', 'ğŸ‘', 'ğŸ‰', 'ğŸ”¥', 'âœ¨', 'ğŸ’–', 'ğŸ’•', 'ğŸ’¯', 'ğŸ™', 'ğŸ‘', 'ğŸŒ¹'],
      'è¡¨æƒ…': ['ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜†', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š'],
      'æ‰‹åŠ¿': ['ğŸ‘', 'ğŸ‘', 'ğŸ‘Š', 'âœŠ', 'ğŸ¤›', 'ğŸ¤œ', 'ğŸ¤', 'âœŒï¸', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ‘Œ', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ‘‡', 'â˜ï¸', 'âœ‹', 'ğŸ¤š', 'ğŸ–', 'ğŸ––'],
      'åŠ¨ç‰©': ['ğŸ±', 'ğŸ¶', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ', 'ğŸ™ˆ', 'ğŸ™‰', 'ğŸ™Š', 'ğŸ”', 'ğŸ§'],
      'é£Ÿç‰©': ['ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ‰', 'ğŸ‡', 'ğŸ“', 'ğŸˆ', 'ğŸ’', 'ğŸ‘', 'ğŸ¥­', 'ğŸ', 'ğŸ¥¥', 'ğŸ¥', 'ğŸ…', 'ğŸ†', 'ğŸ¥‘', 'ğŸ¥¦', 'ğŸ¥¬'],
      'è‡ªç„¶': ['ğŸŒˆ', 'â˜€ï¸', 'ğŸŒ¤', 'â›…ï¸', 'ğŸŒ¥', 'â˜ï¸', 'ğŸŒ¦', 'ğŸŒ§', 'â›ˆ', 'ğŸŒ©', 'ğŸŒ¨', 'â„ï¸', 'â˜ƒï¸', 'â›„ï¸', 'ğŸŒ¬', 'ğŸ’¨', 'ğŸŒª', 'ğŸŒ«', 'ğŸŒŠ', 'ğŸ’§'],
      'ç¬¦å·': ['â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’”', 'â£ï¸', 'ğŸ’•', 'ğŸ’', 'ğŸ’“', 'ğŸ’—', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’', 'ğŸ’Ÿ', 'â˜®ï¸']
    };
    
    const emojis = categoryEmojis[category] || categoryEmojis['å¸¸ç”¨'];
    
    // æ›´æ–°è¡¨æƒ…å®¹å™¨
      emojiContainer.innerHTML = '';
      emojis.forEach(emoji => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'emoji-btn w-8 h-8 text-xl flex items-center justify-center hover:bg-blue-50 rounded-md transition-colors';
        button.textContent = emoji;
      button.onclick = function() {
        insertEmoji(emoji);
      };
        emojiContainer.appendChild(button);
      });
  }
  
  // æ’å…¥è¡¨æƒ…åˆ°ç•™è¨€å†…å®¹
  function insertEmoji(emoji) {
    const contentEl = document.getElementById('content');
    if (!contentEl) return;
    
    const start = contentEl.selectionStart;
    const end = contentEl.selectionEnd;
    const text = contentEl.value;
    const newText = text.substring(0, start) + emoji + text.substring(end);
    
    contentEl.value = newText;
    contentEl.selectionStart = contentEl.selectionEnd = start + emoji.length;
    
    // å…³é—­è¡¨æƒ…é€‰æ‹©å™¨
    const emojiPicker = document.getElementById('emoji-picker');
    if (emojiPicker) emojiPicker.classList.add('hidden');
    
    // è§¦å‘å†…å®¹æ›´æ–°äº‹ä»¶
    contentEl.dispatchEvent(new Event('input'));
  }
  
  // è®¾ç½®æ ·å¼é¢„è®¾
  function setStylePreset(index) {
    const presets = [
      { name: 'ç®€çº¦ç™½', backgroundColor: '#ffffff', textColor: '#374151', borderStyle: 'solid', boxShadow: '0 4px 6px rgba(0, 0, 0, 0.05)' },
      { name: 'æš–é˜³', backgroundColor: '#fff7ed', textColor: '#c2410c', borderStyle: 'solid', boxShadow: '0 4px 10px rgba(194, 65, 12, 0.1)' },
      { name: 'æµ·æ´‹', backgroundColor: '#f0f9ff', textColor: '#0369a1', borderStyle: 'solid', boxShadow: '0 4px 10px rgba(3, 105, 161, 0.1)' },
      { name: 'æ£®æ—', backgroundColor: '#f0fdf4', textColor: '#166534', borderStyle: 'solid', boxShadow: '0 4px 10px rgba(22, 101, 52, 0.1)' },
      { name: 'æ™šéœ', backgroundColor: '#fef2f2', textColor: '#b91c1c', borderStyle: 'solid', boxShadow: '0 4px 10px rgba(185, 28, 28, 0.1)' },
      { name: 'è‘¡è„', backgroundColor: '#faf5ff', textColor: '#7e22ce', borderStyle: 'dashed', boxShadow: '0 4px 10px rgba(126, 34, 206, 0.1)' },
      { name: 'æ¨±èŠ±', backgroundColor: '#fdf4ff', textColor: '#a21caf', borderStyle: 'dashed', boxShadow: '0 4px 10px rgba(162, 28, 175, 0.1)' },
      { name: 'æ¸…æ–°', backgroundColor: '#ecfeff', textColor: '#0e7490', borderStyle: 'dotted', boxShadow: '0 4px 10px rgba(14, 116, 144, 0.1)' },
      { name: 'ç°è°ƒ', backgroundColor: '#f8fafc', textColor: '#334155', borderStyle: 'none', boxShadow: '0 4px 6px rgba(51, 65, 85, 0.05)' },
      { name: 'æ—¥è½', backgroundColor: '#fefce8', textColor: '#854d0e', borderStyle: 'solid', boxShadow: '0 4px 10px rgba(133, 77, 14, 0.1)' },
      { name: 'å®é™', backgroundColor: '#f5f5f5', textColor: '#262626', borderStyle: 'solid', boxShadow: '0 4px 6px rgba(0, 0, 0, 0.03)' },
      { name: 'ç«ç‘°', backgroundColor: '#fff1f2', textColor: '#be123c', borderStyle: 'solid', boxShadow: '0 4px 10px rgba(190, 18, 60, 0.1)' }
    ];
    
    if (index < 0 || index >= presets.length) return;
    
    const preset = presets[index];
    
    // æ›´æ–°éšè—å­—æ®µ
    const bgColorField = document.getElementById('background-color');
    const textColorField = document.getElementById('text-color');
    const borderStyleField = document.getElementById('border-style');
    
    if (bgColorField) bgColorField.value = preset.backgroundColor;
    if (textColorField) textColorField.value = preset.textColor;
    if (borderStyleField) borderStyleField.value = preset.borderStyle;
    
    // æ›´æ–°æ ·å¼é¢„è®¾é€‰ä¸­çŠ¶æ€
    const presetButtons = document.querySelectorAll('.style-preset');
    presetButtons.forEach((button, i) => {
      if (i === index) {
        button.classList.add('ring-2', 'ring-offset-2', 'ring-blue-500');
    } else {
        button.classList.remove('ring-2', 'ring-offset-2', 'ring-blue-500');
      }
    });
    
    // æ›´æ–°é¢„è§ˆ
    updatePreview();
  }
  
  // è·å–QQå¤´åƒ
  function updateQQAvatar() {
    const qqEmailEl = document.getElementById('qq-email');
    const avatarPreview = document.getElementById('avatar-preview');
    
    if (!qqEmailEl || !avatarPreview) return;
    
    const qqEmail = qqEmailEl.value.trim();
    
    // æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„QQé‚®ç®±æ ¼å¼
    if (/^[0-9]+@qq\.com$/.test(qqEmail)) {
      const qqNumber = qqEmail.split('@')[0];
      const avatarUrl = `https://q1.qlogo.cn/g?b=qq&nk=${qqNumber}&s=100`;
      
      // æ›´æ–°å¤´åƒé¢„è§ˆ
      avatarPreview.innerHTML = `<img src="${avatarUrl}" alt="QQå¤´åƒ" class="w-full h-full object-cover rounded-full" loading="lazy" onerror="this.parentNode.innerHTML=''" />`;
    } else {
      // æ¸…é™¤å¤´åƒé¢„è§ˆ
      avatarPreview.innerHTML = '';
    }
  }
  
  // è¡¨å•éªŒè¯
  function validateForm() {
    const nickname = document.getElementById('nickname')?.value.trim();
    const content = document.getElementById('content')?.value.trim();
    const errorMessageText = document.getElementById('error-message-text');
    const errorMessage = document.getElementById('form-error-message');
    
    // åˆ›å»ºIPå“ˆå¸Œ
    const ipHash = 'anon-' + Math.random().toString(36).substring(2, 12);
    const ipHashField = document.getElementById('ip-hash');
    if (ipHashField) ipHashField.value = ipHash;
    
    // éªŒè¯æ˜µç§°
    if (!nickname) {
      if (errorMessageText) errorMessageText.textContent = 'è¯·è¾“å…¥æ˜µç§°';
      if (errorMessage) errorMessage.classList.remove('hidden');
      return false;
    }
    
    // éªŒè¯ç•™è¨€å†…å®¹
    if (!content) {
      if (errorMessageText) errorMessageText.textContent = 'è¯·è¾“å…¥ç•™è¨€å†…å®¹';
      if (errorMessage) errorMessage.classList.remove('hidden');
      return false;
    }
    
    // éªŒè¯é€šè¿‡ï¼Œéšè—é”™è¯¯ä¿¡æ¯
    if (errorMessage) errorMessage.classList.add('hidden');
    return true;
  }
  
  // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
  function showLoadingState() {
    const loadingMessage = document.getElementById('form-loading-message');
    const successMessage = document.getElementById('form-success-message');
    const errorMessage = document.getElementById('form-error-message');
    const submitButton = document.getElementById('submit-button');
    
    if (loadingMessage) loadingMessage.classList.remove('hidden');
    if (successMessage) successMessage.classList.add('hidden');
    if (errorMessage) errorMessage.classList.add('hidden');
    if (submitButton) submitButton.disabled = true;
  }
  
  // éšè—åŠ è½½çŠ¶æ€
  function hideLoadingState() {
    const loadingMessage = document.getElementById('form-loading-message');
    const submitButton = document.getElementById('submit-button');
    
    if (loadingMessage) loadingMessage.classList.add('hidden');
    if (submitButton) submitButton.disabled = false;
      }
      
  // æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
  function showSuccessMessage() {
    const successMessage = document.getElementById('form-success-message');
    if (successMessage) successMessage.classList.remove('hidden');
    
    // 5ç§’åè‡ªåŠ¨å…³é—­è¡¨å•æ¨¡æ€æ¡†
    setTimeout(() => {
      const formModal = document.getElementById('form-modal');
      if (formModal) {
        formModal.classList.add('hidden');
        document.body.style.overflow = '';
      }
      
      // æ¸…ç©ºè¡¨å•
      const form = document.getElementById('guestbook-form');
      if (form) form.reset();
      
      // åˆ·æ–°ç•™è¨€åˆ—è¡¨
            if (typeof window.refreshMessages === 'function') {
              window.refreshMessages();
      }
    }, 2000);
  }
  
  // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
  function showErrorMessage(message) {
    const errorMessage = document.getElementById('form-error-message');
    const errorMessageText = document.getElementById('error-message-text');
    
    if (errorMessage) errorMessage.classList.remove('hidden');
    if (errorMessageText) errorMessageText.textContent = message || 'æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•';
  }
  
  // å¤„ç†è¡¨å•æäº¤ï¼ˆå®¢æˆ·ç«¯ç›´æ¥å‘é€åˆ°Supabaseï¼‰
  async function handleFormSubmit(event) {
    event.preventDefault();
    
    if (!validateForm()) {
      return false;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    showLoadingState();
    
    try {
      // è·å–è¡¨å•æ•°æ®
      const form = document.getElementById('guestbook-form');
      const formData = new FormData(form);
      
      // è·å–ç”¨æˆ·åœ°ç†ä½ç½®å’Œè¿è¥å•†
      let locationInfo = 'æœªçŸ¥ä½ç½®';
      let operatorInfo = '';
      
      try {
        // ç›´æ¥ä½¿ç”¨IPIP.net APIè·å–ä½ç½®ä¿¡æ¯ï¼ˆç»è¿‡æµ‹è¯•æ›´å‡†ç¡®ä¸”æœ‰è¿è¥å•†ä¿¡æ¯ï¼‰
        const ipipResponse = await fetch('https://myip.ipip.net', {
          headers: {
            'Accept': 'text/html'
          }
        });
        
        if (ipipResponse.ok) {
          const text = await ipipResponse.text();
          // è§£æIPIP.netå“åº”æ ¼å¼ï¼Œä¾‹å¦‚ï¼šå½“å‰ IPï¼š240e:388:6429:4900:2d00:da33:d52:a44f  æ¥è‡ªäºï¼šä¸­å›½ æµ™æ±Ÿ æ­å· è¿è¥å•†ï¼šç§»åŠ¨
          console.log('IPIP.netå“åº”:', text);
          
          // æå–ä½ç½®ä¿¡æ¯
          const locationMatch = text.match(/æ¥è‡ªäºï¼š([^è¿]+)/);
          if (locationMatch && locationMatch[1]) {
            locationInfo = locationMatch[1].trim().replace(/\s+/g, ' Â· ');
          }
          
          // æå–è¿è¥å•†ä¿¡æ¯
          const operatorMatch = text.match(/è¿è¥å•†ï¼š(.+?)($|\s|\n)/);
          if (operatorMatch && operatorMatch[1]) {
            operatorInfo = operatorMatch[1].trim();
          }
          
          console.log('æå–çš„ä½ç½®ä¿¡æ¯:', locationInfo);
          console.log('æå–çš„è¿è¥å•†ä¿¡æ¯:', operatorInfo);
        }
      } catch (locationError) {
        console.error('è·å–ä½ç½®ä¿¡æ¯å¤±è´¥:', locationError);
      }
      
      // è½¬æ¢ä¸ºå¯¹è±¡
      const messageData = {
        nickname: formData.get('nickname'),
        content: formData.get('content'),
        qq_email: formData.get('qq_email') || '',
        background_color: formData.get('background_color') || '#ffffff',
        text_color: formData.get('text_color') || '#374151',
        border_style: formData.get('border_style') || 'solid',
        ip_hash: formData.get('ip_hash') || `anon-${Date.now()}`,
        created_at: new Date().toISOString(),
        location: locationInfo, // æ·»åŠ ä½ç½®ä¿¡æ¯
        operator: operatorInfo // æ·»åŠ è¿è¥å•†ä¿¡æ¯
      };
      
      // ç›´æ¥è°ƒç”¨Supabaseçš„å®¢æˆ·ç«¯API
      const response = await fetch('https://phbwtexlsszkeotrrmws.supabase.co/rest/v1/guestbook_messages', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBoYnd0ZXhsc3N6a2VvdHJybXdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDcyMDc3MjUsImV4cCI6MjA2Mjc4MzcyNX0.D7Tt-qL0wZRqHKpR3fOUjse4sp_Z4ixTFBTd_Y0IZvw',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify(messageData)
      });
      
      if (response.ok) {
        // æäº¤æˆåŠŸ
        hideLoadingState();
        showSuccessMessage();
      } else {
        // æäº¤å¤±è´¥
        console.error('æäº¤ç•™è¨€å¤±è´¥:', response.status, response.statusText);
        hideLoadingState();
        showErrorMessage('æäº¤å¤±è´¥ï¼ŒæœåŠ¡å™¨å“åº”å¼‚å¸¸');
      }
    } catch (error) {
      console.error('æäº¤ç•™è¨€å¼‚å¸¸:', error);
      hideLoadingState();
      showErrorMessage(error.message || 'æäº¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    }
  }

  // åˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–è¡¨å•å†…å®¹é•¿åº¦è®¡æ•°
    updateContentLength();
    
    // è®¾ç½®é»˜è®¤æ ·å¼
    setStylePreset(0);
    
    // ç‚¹å‡»é¡µé¢å…¶ä»–ä½ç½®å…³é—­è¡¨æƒ…é€‰æ‹©å™¨
    document.addEventListener('click', function(event) {
      const emojiPicker = document.getElementById('emoji-picker');
      const emojiButton = document.getElementById('emoji-button');
      
      if (emojiPicker && !emojiPicker.classList.contains('hidden') && 
          !emojiPicker.contains(event.target) && 
          emojiButton && !emojiButton.contains(event.target)) {
        emojiPicker.classList.add('hidden');
  }
    });
  });
</script>

<style>
  /* éšè—æ¨ªå‘æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
  .hide-scrollbar {
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
  }
  .hide-scrollbar::-webkit-scrollbar {
    display: none;  /* Chrome, Safari, Opera */
  }
</style> 